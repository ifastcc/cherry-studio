name: My Custom Auto Release

on:
  schedule:
    - cron: "0 6 * * *" # 每天 14:00 BJ Time 检测一次上游更新
  workflow_dispatch:
    inputs:
      force_tag:
        description: "若需手动打包特定 Tag 请在此填写（例如 v1.0.0）。留空则自动检测是否有新版本。"
        required: false
        default: ""

permissions:
  contents: write

jobs:
  sync_and_prepare:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      tag: ${{ steps.check.outputs.tag }}
      build_ref: ${{ steps.check.outputs.build_ref }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check and Sync
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          INPUT_TAG="${{ github.event.inputs.force_tag }}"
          TARGET_TAG=""

          if [ -n "$INPUT_TAG" ]; then
            if [[ "$INPUT_TAG" != v* ]]; then
              INPUT_TAG="v$INPUT_TAG"
            fi
            TARGET_TAG="$INPUT_TAG"
            echo "Manual tag requested: $TARGET_TAG"
          else
            # 自动模式：只看 upstream 最新 release tag，不跟 upstream/main
            git clone --bare https://github.com/CherryHQ/cherry-studio.git upstream_repo
            TARGET_TAG=$(cd upstream_repo && git tag -l "v*" --sort=-v:refname | head -n 1)

            if [ -z "$TARGET_TAG" ]; then
              echo "No tags found on upstream."
              echo "should_build=false" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "Latest upstream release tag: $TARGET_TAG"
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote add upstream https://github.com/CherryHQ/cherry-studio.git || git remote set-url upstream https://github.com/CherryHQ/cherry-studio.git
          git tag -d "$TARGET_TAG" >/dev/null 2>&1 || true
          git fetch upstream +refs/tags/"$TARGET_TAG":refs/tags/"$TARGET_TAG"
          git checkout main

          # 将上游 release tag 合入 fork/main；保留本仓库 workflows
          git merge "$TARGET_TAG" --no-commit --no-ff || true
          if git ls-files -u | grep -q .; then
            echo "::error::Merge conflicts detected when syncing $TARGET_TAG. Please resolve manually."
            git merge --abort || true
            exit 1
          fi

          git restore --source=HEAD --staged --worktree .github/workflows/ || true

          if git diff --cached --quiet; then
            echo "No new changes after merging $TARGET_TAG."
          else
            git commit -m "chore: sync stable release $TARGET_TAG from upstream excluding workflows modifications"
            git push origin main
          fi

          # 若本仓库已存在同名 tag，先删除，确保本次发布重新打新 tag 指向最新构建 commit
          if git ls-remote --tags origin "refs/tags/$TARGET_TAG" | grep -q "$TARGET_TAG"; then
            echo "Deleting existing remote tag: $TARGET_TAG"
            git push origin ":refs/tags/$TARGET_TAG"
          fi

          BUILD_SHA=$(git rev-parse HEAD)
          echo "should_build=true" >> $GITHUB_OUTPUT
          echo "tag=$TARGET_TAG" >> $GITHUB_OUTPUT
          echo "build_ref=$BUILD_SHA" >> $GITHUB_OUTPUT

  build_and_release:
    needs: sync_and_prepare
    if: needs.sync_and_prepare.outputs.should_build == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      # 串行构建并保持顺序，优先构建 macOS
      max-parallel: 1
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
      fail-fast: false

    steps:
      - name: Check out fork repository code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ needs.sync_and_prepare.outputs.build_ref }}

      - name: Verify topic sync patch exists
        shell: bash
        run: |
          test -f src/renderer/src/pages/settings/DataSettings/TopicSyncSettings.tsx
          grep -q "key: 'topic_sync'" src/renderer/src/pages/settings/DataSettings/DataSettings.tsx
          grep -q '"topic_sync"' src/renderer/src/i18n/locales/zh-cn.json

      - name: Set package.json version
        shell: bash
        run: |
          TAG="${{ needs.sync_and_prepare.outputs.tag }}"
          VERSION="${TAG#v}"
          npm version "$VERSION" --no-git-tag-version --allow-same-version

      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: macos-latest dependencies fix
        if: matrix.os == 'macos-latest'
        run: |
          brew install python-setuptools

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

      - name: Cache pnpm dependencies
        uses: actions/cache@v5
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install Dependencies
        run: pnpm install

      - name: Build Linux
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get install -y rpm
          pnpm build:linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_OPTIONS: --max-old-space-size=8192
          MAIN_VITE_CHERRYAI_CLIENT_SECRET: ${{ secrets.MAIN_VITE_CHERRYAI_CLIENT_SECRET }}
          MAIN_VITE_MINERU_API_KEY: ${{ secrets.MAIN_VITE_MINERU_API_KEY }}
          RENDERER_VITE_AIHUBMIX_SECRET: ${{ secrets.RENDERER_VITE_AIHUBMIX_SECRET }}
          RENDERER_VITE_PPIO_APP_SECRET: ${{ secrets.RENDERER_VITE_PPIO_APP_SECRET }}

      - name: Build Mac
        if: matrix.os == 'macos-latest'
        run: |
          sudo -H pip install setuptools || true
          pnpm build:mac
        env:
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_OPTIONS: --max-old-space-size=8192
          MAIN_VITE_CHERRYAI_CLIENT_SECRET: ${{ secrets.MAIN_VITE_CHERRYAI_CLIENT_SECRET }}
          MAIN_VITE_MINERU_API_KEY: ${{ secrets.MAIN_VITE_MINERU_API_KEY }}
          RENDERER_VITE_AIHUBMIX_SECRET: ${{ secrets.RENDERER_VITE_AIHUBMIX_SECRET }}
          RENDERER_VITE_PPIO_APP_SECRET: ${{ secrets.RENDERER_VITE_PPIO_APP_SECRET }}

      - name: Build Windows
        if: matrix.os == 'windows-latest'
        run: pnpm build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_OPTIONS: --max-old-space-size=8192
          MAIN_VITE_CHERRYAI_CLIENT_SECRET: ${{ secrets.MAIN_VITE_CHERRYAI_CLIENT_SECRET }}
          MAIN_VITE_MINERU_API_KEY: ${{ secrets.MAIN_VITE_MINERU_API_KEY }}
          RENDERER_VITE_AIHUBMIX_SECRET: ${{ secrets.RENDERER_VITE_AIHUBMIX_SECRET }}
          RENDERER_VITE_PPIO_APP_SECRET: ${{ secrets.RENDERER_VITE_PPIO_APP_SECRET }}

      - name: Upload to Github Release
        uses: ncipollo/release-action@v1
        with:
          draft: false
          allowUpdates: true
          replacesArtifacts: true
          makeLatest: true
          # 将 release tag 绑定到本次实际构建的 commit
          commit: ${{ needs.sync_and_prepare.outputs.build_ref }}
          name: "Cherry Studio ${{ needs.sync_and_prepare.outputs.tag }}"
          tag: ${{ needs.sync_and_prepare.outputs.tag }}
          artifacts: "dist/*.exe,dist/*.zip,dist/*.dmg,dist/*.AppImage,dist/*.snap,dist/*.deb,dist/*.rpm,dist/*.tar.gz,dist/latest*.yml,dist/rc*.yml,dist/beta*.yml,dist/*.blockmap"
          token: ${{ secrets.GITHUB_TOKEN }}
